def dockerImageDir = "${projectDir}/docker/images"
def dockerImageBuildDir = "${dockerImageDir}/build"

task buildAuthoringTomcatDocker {
    def buildDir = "${dockerImageBuildDir}/authoring/tomcat"

    doFirst {
        delete buildDir
        mkdir buildDir 
    }

    doLast {
        copy {
            from "${dockerImageDir}/authoring/tomcat/"
            into buildDir
        }

        copy {
            from "${authEnvDir}/bin/"
            into "${buildDir}/bin"     
            exclude "migration"
            exclude "upgrade"
            exclude "crafter-deployer"
            exclude "elasticsearch"
            exclude "solr"
            exclude "dbms"
            exclude "apache-tomcat/work/**"
            exclude "apache-tomcat/temp/**"
            exclude "apache-tomcat/webapps/crafter-search*"
            exclude "apache-tomcat/webapps/ROOT"
            exclude "apache-tomcat/webapps/studio"
            exclude "**/*.pid"
        }

        exec {
            commandLine commandLinePrefix + ['docker', 'build', '-t', 'craftercms/authoring_tomcat', buildDir]
        }
    }
}

task buildDeliveryTomcatDocker {
    def buildDir = "${dockerImageBuildDir}/delivery/tomcat"

    doFirst {
        delete buildDir
        mkdir buildDir 
    }

    doLast {
        copy {
            from "${dockerImageDir}/delivery/tomcat/"
            into buildDir
        }

        copy {
            from "${deliveryEnvDir}/bin/"
            into "${buildDir}/bin"     
            exclude "migration"
            exclude "upgrade"
            exclude "crafter-deployer"
            exclude "elasticsearch"
            exclude "solr"
            exclude "apache-tomcat/work/**"
            exclude "apache-tomcat/temp/**"
            exclude "apache-tomcat/webapps/crafter-search*"
            exclude "apache-tomcat/webapps/ROOT"
            exclude "**/*.pid"
        }

        exec {
            commandLine commandLinePrefix + ['docker', 'build', '-t', 'craftercms/delivery_tomcat', buildDir]
        }
    }
}

task buildServerlessS3DeliveryTomcat {
    dependsOn 'buildDeliveryTomcatDocker'

    doLast {
        exec {
            commandLine commandLinePrefix + ['docker', 'build', '-t', 'craftercms/serverless_s3_delivery_tomcat', 
                "${dockerImageDir}/serverless/s3/delivery/tomcat"]
        }
    }
}

task buildDeployerDocker {
    def buildDir = "${dockerImageBuildDir}/deployer"

    doFirst {
        delete buildDir
        mkdir buildDir 
    }

    doLast {
        copy {
            from "${dockerImageDir}/deployer/"
            into buildDir
        }

        copy {
            from "${deliveryEnvDir}/bin/"
            into "${buildDir}/bin"     
            exclude "migration"
            exclude "upgrade"
            exclude "apache-tomcat"
            exclude "elasticsearch"
            exclude "solr"
            exclude "**/*.pid"
        }

        exec {
            commandLine commandLinePrefix + ['docker', 'build', '-t', 'craftercms/deployer', buildDir]
        }
    }
}

task buildAuthoringDockers {
    dependsOn 'buildAuthoringTomcatDocker'
}

task buildDeliveryDockers {
    dependsOn 'buildDeployerDocker'
    dependsOn 'buildDeliveryTomcatDocker'
    dependsOn 'buildServerlessS3DeliveryTomcat'
}
